<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品管理</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/myall.css">
    <style>
        body {
            background: linear-gradient(to bottom right, rgb(1, 17, 21) 0%, rgb(84, 136, 240) 100%);
            margin: 0;
            padding: 0;
            background-repeat: no-repeat;
            background-size: cover;
        }

        #sec02 {
            min-height: 100vh;
        }

        .table-rwd tbody tr td {
            text-align: center;
            vertical-align: middle;
        }

        .table-title {
            text-align: center;
            vertical-align: middle;
        }


        @media screen and (max-width: 768px) {
            .table-rwd thead {
                display: none;
            }

            .table-rwd tbody tr {
                display: block;
                border: 5px solid var(--CelestialGreen04);
                margin-top: 10px;
            }

            .table-rwd tbody tr td {
                display: block;
                overflow: hidden;
            }

            .table-rwd tbody tr td::before {
                content: attr(data-code)" : ";
                color: var(--CelestialGreen04);
                font-weight: 700;
                display: block;
                float: left;
                width: 6em;
                text-align: right;
                padding-right: 2em;
            }

            .table-rwd tbody tr td span.table-col {
                display: block;
                float: left;
                width: calc(100% - 6em);
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                控制台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <div class="ms-auto">
                    <span class="text-warning h3" id="user_message"></span>
                    <button class="btn btn-danger d-none" id="logout_btn">登出</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="container fs02" id="sec02">
        <table class="table table-bordered table-hover table-sm border-success table-rwd mt-2">
            <div class="row">
                <div class="col-3 my-2 fse01 fw-800">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal"
                        id="create_btn">新增商品</button>
                    <button class="btn btn-secondary ms-1" data-bs-toggle="modal" data-bs-target="#sortModal"
                        id="sort_btn">新增類別</button>
                </div>
                <div class="col-4 my-2">
                    <select name="showSort" id="showSort" class="form-select">
                        <option selected disabled>--依類別顯示--</option>
                        <option value="全部">全部</option>
                        <option value="類別A">類別A</option>
                        <option value="類別B">類別B</option>
                        <option value="類別C">類別C</option>
                    </select>
                </div>
            </div>
            <caption class="text-end fse01 fw-800">商品列表</caption>
            <thead class="table-primary table-title">
                <tr class="fse01">
                    <th width="5%">類別</th>
                    <th width="10%">圖示</th>
                    <th width="15%">名稱</th>
                    <th width="25%">說明</th>
                    <th width="10%">價格</th>
                    <th width="5%">數量</th>
                    <th width="5%">狀態</th>
                    <th width="15%">建立時間</th>
                    <th width="10%">資料修改</th>
                </tr>
            </thead>
            <tbody id="mybody" class="fw-600">
                <tr style="height: 5%;">
                    <td>xx</td>
                    <td>xx</td>
                    <td>xx</td>
                    <td>xx</td>
                    <td>xx</td>
                    <td>xx</td>
                    <td>xx</td>
                    <td>xx</td>
                    <td>
                        <button class="btn btn-success me-1">更新</button>
                        <button class="btn btn-danger">刪除</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center fixed-bottom" id="pageList">
            <li class="page-item"><a class="page-link" href="#" onclick="drawTable(0)">1</a></li>
        </ul>
    </nav>


    <!-- 新增商品 Modal -->
    <div class="modal fade modal-slide-from-bottom" id="createModal" data-bs-backdrop="static" data-bs-keyboard="false"
        tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="mb-3">
                        <select name="sort" id="sort" class="form-select is-invalid">
                            <option selected disabled>--商品類別--</option>
                            <option value="類別A">類別A</option>
                            <option value="類別B">類別B</option>
                            <option value="類別C">類別C</option>
                        </select>
                        <div class="valid-feedback">OK</div>
                        <div class="invalid-feedback">請選擇類別</div>
                    </div>
                    <div class="mb-3">
                        <label for="itemName" class="form-label">商品名稱</label>
                        <input type="text" id="itemName" name="itemName" class="form-control" placeholder="16個字以內">
                        <div class="valid-feedback" id="okFeed"></div>
                        <div class="invalid-feedback" id="notFeed"></div>
                    </div>
                    <div class="mb-3">
                        <label for="itemContent" class="form-label">商品說明</label>
                        <textarea id="itemContent" name="itemContent" class="form-control"
                            placeholder="輸入商品描述"></textarea>
                        <div class="valid-feedback" id="okFeed"></div>
                        <div class="invalid-feedback" id="notFeed"></div>
                    </div>
                    <div class="mb-3">
                        <label for="itemPrice" class="form-label">商品價格</label>
                        <input type="number" min="0" max="1000000" value="" class="form-control" id="itemPrice"
                            name="itemPrice">
                        <div class="valid-feedback">OK</div>
                        <div class="invalid-feedback">價格不符規定(一百萬以內)</div>
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">商品數量: <span class="h4 text-success"
                                id="amount_text">5</span></label>
                        <input type="range" class="form-range" min="1" max="100" step="1" id="itemAmount"
                            name="itemAmount" value="5">
                    </div>
                    <div class="form-check form-switch">
                        <input type="checkbox" name="itemSell" id="itemSell" class="form-check-input" checked>
                        <label for="itemSell" class="form-check-label">上架</label>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-8">
                            <div class="my-3">
                                <label for="fileUpload" class="form-label">檔案上傳</label>
                                <input type="file" class="form-control" id="fileUpload" name="fileUpload">
                                <img id="preImg" src="#" alt="" class="w-50 mt-3 d-none">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="cfmbtn">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增類別 -->
    <div class="modal fade" id="sortModal" data-bs-backdrop="static" data-bs-keyboard="false"
        tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sortName" class="form-label">類別名稱</label>
                        <input type="text" id="sortName" name="sortName" class="form-control" placeholder="8個字以內">
                        <div class="valid-feedback" id="okFeed"></div>
                        <div class="invalid-feedback" id="notFeed"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="cfmbtn">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- updateModal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">商品資料更新</h1>
                    <button type="button" id="exit_btn" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="upContent" class="form-label">商品說明</label>
                        <textarea id="upContent" name="upContent" class="form-control" placeholder="輸入商品描述"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="upPrice" class="form-label">商品價格</label>
                        <input type="number" min="0" max="1000000" value="100" class="form-control" id="upPrice"
                            name="upPrice">
                        <div class="valid-feedback">OK</div>
                        <div class="invalid-feedback">價格不符規定(一百萬以內)</div>
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">商品數量: <span class="h4 text-success"
                                id="upAmount_text"></span></label>
                        <input type="range" class="form-range" min="1" max="100" step="1" id="upAmount" name="upAmount"
                            value="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancel_btn" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" id="cfm_update_btn" class="btn btn-primary">確認</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        var sell = "Y"; // 紀錄是否上架
        var flag_sort = false;
        var flag_name = false;
        var flag_price = false;
        var flag_upload = false;
        var amount = 5;
        var upAmount;
        var update_id; // update ID 存取更新用
        var newData = []; // for paginate

        $(function () {
            $.ajax({
                type: "GET",
                url: "http://192.168.10.71/Cass01/api/itemFront_api.php",
                dataType: "json",
                async: false, // 正常ajax為最後執行，若要監聽串接資料，需關閉同步
                success: showdata,
                error: function () {
                    alert("接收錯誤!");
                }
            });

            // 監聽取消按鈕
            $("#createModal").on("hidden.bs.modal", function () {
                $("#sort").val("");
                $("#sort").removeClass("is-valid");
                $("#sort").addClass("is-invalid");

                $("#itemName").val("");
                $("#itemName").removeClass("is-valid");
                $("#itemName").addClass("is-invalid");

                $("#itemPrice").val("");
                $("#itemPrice").removeClass("is-valid");
                $("#itemPrice").addClass("is-invalid");

                $("#itemContent").val("");

                $("#itemAmount").val("5");
                $("#amount_text").text("5");

                $("#fileUpload").val("");
                $("#preImg").addClass("d-none");
                $("#preImg").attr("src", "#");

                $("#itemSell").prop("checked", true);
                $("#itemSell").next().text('上架');
                sell = 'Y';

                flag_sort = false;
                flag_name = false;
                flag_price = false;
                flag_upload = false;
            });

            // 即時監聽sort
            $("#sort").bind("input propertychange", function () {
                if ($(this).val() != "") {
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_sort = true;
                }
            });

            // 即時監聽 itemName
            $("#itemName").bind("input propertychange", function () {
                if ($(this).val().length > 0 && $(this).val().length < 17) {
                    // 字數符合規定
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_name = true;
                } else {
                    // 字數不符規定
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    flag_name = false;
                }
            });

            // 即時監聽itemPrice
            $("#itemPrice").bind("input propertychange", function () {
                if ($(this).val() > 0 && $(this).val() < 1000001) {
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_price = true;
                } else {
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    flag_price = false;
                }
            });

            // 即時監聽itemAmount
            $("#itemAmount").bind("input propertychange", function () {
                $("#amount_text").text($(this).val());
                amount = $(this).val();
            });

            // 即時監聽upAmount
            $("#upAmount").bind("input propertychange", function () {
                $("#upAmount_text").text($(this).val());
                upAmount = $(this).val();
            });

            // 監聽itemSell
            $("#itemSell").change(function () {
                if ($(this).is(':checked')) {
                    $(this).next().text('上架');
                    sell = 'Y';
                } else {
                    $(this).next().text('未上架');
                    sell = 'N';
                }
                // next 下一個標籤
            });

            // 上傳圖片
            $("#fileUpload").change(function () {
                if (
                    fileUpload.files[0].type == "image/jpeg" ||
                    fileUpload.files[0].type == "image/png"
                ) {
                    // 顯示預覽圖
                    $("#preImg").removeClass("d-none");
                    $("#preImg").attr("src", URL.createObjectURL(fileUpload.files[0]));
                    flag_upload = true;
                } else {
                    Swal.fire("圖片格式不符合");
                    flag_upload = false;
                }
            });

            // 監聽cfmbtn
            $("#cfmbtn").click(function () {
                if (flag_sort && flag_name && flag_price && flag_upload) {
                    var formdata = new FormData();
                    //push檔案是用append "file"要跟後端一樣
                    formdata.append("file", fileUpload.files[0]);
                    //傳遞formdata去後端
                    $.ajax({
                        type: "POST",
                        url: "http://192.168.10.71/Cass01/api/itemImage_api.php",
                        data: formdata,
                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: createItem,
                        error: function () {
                            alert(
                                "error-http://192.168.10.71/Cass01/api/itemImage_api.php"
                            );
                        },
                    });
                } else {
                    Swal.fire("欄位有誤，請修正!");
                }
            });

            $("#sort_btn").click(function(){

            });

            // 監聽#update_btn
            // $("#mybody #update_btn") : 獲取 '指定區域' 該 '項目' 所有資料避免只取到第一筆
            $("body").on("click", "#mybody #update_btn", function () {
                update_id = $(this).data("id");
                $("#upContent").val($(this).data("content"));
                $("#upPrice").val($(this).data("price"));
                $("#upAmount").val($(this).data("amount"));
                $("#upAmount_text").text($(this).data("amount"));
            });

            // 監聽#cfm_update_btn
            $("#cfm_update_btn").click(function () {
                // 產生json格式參數
                var dataJSON = {};
                dataJSON["id"] = update_id;
                dataJSON["content"] = $("#upContent").val();
                dataJSON["price"] = $("#upPrice").val();
                dataJSON["amount"] = $("#upAmount").val();

                // 傳遞至後端api
                $.ajax({
                    type: "POST",
                    url: "http://192.168.10.71/Cass01/api/itemUpdate_api.php",
                    data: JSON.stringify(dataJSON),
                    dataType: "json",
                    success: updateSuc,
                    error: function () {
                        alert("error-http://192.168.10.71/Cass01/api/itemUpdate_api.php");
                    }
                });
            });

            // 監聽#delete_btn
            $("body").on("click", "#mybody #delete_btn", function () {
                delName = $(this).data("name");
                Swal.fire({
                    title: "確定刪除" + [delName] + "?",
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: "沒錯!",
                    denyButtonText: "按錯了"
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */
                    if (result.isConfirmed) {
                        var dataJSON = {};
                        dataJSON["id"] = $(this).data("id");

                        $.ajax({
                            type: "POST",
                            url: "http://192.168.10.71/Cass01/api/itemDelete_api.php",
                            data: JSON.stringify(dataJSON),
                            dataType: "json",
                            success: deleteSuc,
                            error: function () {
                                alert("error-http://192.168.10.71/Cass01/api/itemDelete_api.php");
                            }
                        });
                    } else if (result.isDenied) {

                    }
                });
            });
        });

        function createItem(data) {
            var dataJSON = {};
            dataJSON["sort_name"] = $("#sort").val();
            dataJSON["name"] = $("#itemName").val();
            dataJSON["content"] = $("#itemContent").val();
            dataJSON["price"] = $("#itemPrice").val();
            dataJSON["amount"] = amount;
            dataJSON["image"] = data.datainfo["name"];
            dataJSON["sell"] = sell;

            $.ajax({
                type: "POST",
                url: "http://192.168.10.71/Cass01/api/item-Create_api.php",
                data: JSON.stringify(dataJSON),
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: createSuc,
                error: function () {
                    Swal.fire("error-http://192.168.10.71/Cass01/api/item-Create_api.php");
                }
            });
        }

        function showdata(data) {
            // 整理資料存為二維陣列
            data.data.forEach(function (item, key) {
                if (key % 10 == 0) {
                    newData.push([]);
                }
                var page = parseInt(key / 10);
                newData[page].push(item);
            });
            drawTable(0);

            // 產生頁碼
            updatePageButtons(0);
        }

        function drawTable(page) {
            $("#mybody").empty();
            newData[page].forEach(function (item) {
                var strHTML = '<tr style="height: 7vh;"><td>' + item.sort_name + '</td><td><img src="../Cass01_image/admin/product/' + item.image + '" style="width: 100px;"></td><td>' + item.name + '</td><td>' + item.content + '</td><td>' + item.price + '</td><td>' + item.amount + '</td><td>' + item.sell + '</td><td>' + item.created_at + '</td><td td class="text-center align-middle"><button id="update_btn" class=" btn btn-success py-3 me-1" data-bs-toggle="modal" data-bs-target="#updateModal" data-id="' + item.id + '" data-content="' + item.content + '" data-price="' + item.price + '" data-amount="' + item.amount + '">更新</button><button id="delete_btn" data-id="' + item.id + '" data-name="' + item.name + '" class="btn btn-danger py-3">刪除</button></td></tr>';
                $("#mybody").append(strHTML);
            });

            // 更新頁碼
            updatePageButtons(page);
        }

        function updatePageButtons(page) {
            $("#pageList").empty();

            // 上一頁按鈕
            var prevPage = page - 1;
            if (prevPage >= 0) {
                var prevHTML = '<li class="page-item"><a class="page-link" href="#" onclick="drawTable(' + prevPage + ')">上一頁</a></li>';
                $("#pageList").append(prevHTML);
            }

            // 產生頁碼
            newData.forEach(function (item, key) {
                var thisPage = key + 1;
                var activeClass = (key === page) ? "active" : ""; // 確認是否為當前頁碼，是則加入 active 樣式
                var strHTML = '<li class="page-item ' + activeClass + '"><a class="page-link" href="#" onclick="drawTable(' + key + ')">' + thisPage + '</a></li>';
                $("#pageList").append(strHTML);
            });

            // 下一頁按鈕
            var nextPage = page + 1;
            if (nextPage < newData.length) {
                var nextHTML = '<li class="page-item"><a class="page-link" href="#" onclick="drawTable(' + nextPage + ')">下一頁</a></li>';
                $("#pageList").append(nextHTML);
            }
        }

        function createSuc(data) {
            if (data.state) {
                // alert(data.message);
                Swal.fire({
                    title: "新增成功!",
                    showDenyButton: false,
                    showCancelButton: false,
                    confirmButtonText: "確認",
                    denyButtonText: ``
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */
                    if (result.isConfirmed) {
                        Swal.fire("Saved!", "", "success");
                        location.href = "http://192.168.10.71/Cass01/itemFront.html";
                    } else if (result.isDenied) {
                        Swal.fire("Changes are not saved", "", "info");
                    }
                });
            } else {
                alert(data.message);
            }
        }

        function updateSuc(data) {
            if (data.state) {
                // alert(data.message);
                Swal.fire({
                    title: "更新完成!",
                    showDenyButton: false,
                    showCancelButton: false,
                    confirmButtonText: "確認",
                    denyButtonText: ``
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */
                    if (result.isConfirmed) {
                        Swal.fire("Saved!", "", "success");
                        location.href = "http://192.168.10.71/Cass01/itemFront.html";
                    } else if (result.isDenied) {
                        Swal.fire("Changes are not saved", "", "info");
                    }
                });
            } else {
                alert(data.message);
            }
        }

        function deleteSuc(data) {
            if (data.state) {
                // alert(data.message);
                Swal.fire({
                    title: "刪除完成!",
                    showDenyButton: false,
                    showCancelButton: false,
                    confirmButtonText: "確認",
                    denyButtonText: ``
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */
                    if (result.isConfirmed) {
                        Swal.fire("Saved!", "", "success");
                        location.href = "http://192.168.10.71/Cass01/itemFront.html";
                    } else if (result.isDenied) {
                        Swal.fire("Changes are not saved", "", "info");
                    }
                });
            } else {
                alert(data.message);
            }
        }
    </script>
</body>

</html>